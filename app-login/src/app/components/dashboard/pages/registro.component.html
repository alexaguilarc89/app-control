<div class="container-fluid p-4">
  <h1 class="mb-4">
    <i class="bi bi-clipboard-check"></i> Registro de Sectoristas
  </h1>

  <!-- Sección Formulario Sectorista -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        {{ currentSectorista ? 'Editar Sectorista' : 'Nuevo Sectorista' }}
      </h5>
    </div>
    <div class="card-body">
      <form [formGroup]="sectoristasForm" (ngSubmit)="currentSectorista ? guardarEdicion() : onSubmit()">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="nombres" class="form-label">Nombres</label>
              <input
                type="text"
                class="form-control"
                id="nombres"
                formControlName="nombres"
                [class.is-invalid]="submitted && f['nombres'].invalid"
                placeholder="Ingresa nombres"
              />
              <div *ngIf="submitted && f['nombres'].invalid" class="invalid-feedback d-block">
                <small *ngIf="f['nombres'].errors?.['required']">Campo requerido</small>
                <small *ngIf="f['nombres'].errors?.['minlength']">Mínimo 3 caracteres</small>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="apellidos" class="form-label">Apellidos</label>
              <input
                type="text"
                class="form-control"
                id="apellidos"
                formControlName="apellidos"
                [class.is-invalid]="submitted && f['apellidos'].invalid"
                placeholder="Ingresa apellidos"
              />
              <div *ngIf="submitted && f['apellidos'].invalid" class="invalid-feedback d-block">
                <small *ngIf="f['apellidos'].errors?.['required']">Campo requerido</small>
                <small *ngIf="f['apellidos'].errors?.['minlength']">Mínimo 3 caracteres</small>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="telefono" class="form-label">Teléfono</label>
              <input
                type="tel"
                class="form-control"
                id="telefono"
                formControlName="telefono"
                [class.is-invalid]="submitted && f['telefono'].invalid"
                placeholder="Ingresa teléfono"
              />
              <div *ngIf="submitted && f['telefono'].invalid" class="invalid-feedback d-block">
                <small *ngIf="f['telefono'].errors?.['required']">Campo requerido</small>
                <small *ngIf="f['telefono'].errors?.['pattern']">Mínimo 7 dígitos</small>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="correo" class="form-label">Correo</label>
              <input
                type="email"
                class="form-control"
                id="correo"
                formControlName="correo"
                [class.is-invalid]="submitted && f['correo'].invalid"
                placeholder="correo@ejemplo.com"
              />
              <div *ngIf="submitted && f['correo'].invalid" class="invalid-feedback d-block">
                <small *ngIf="f['correo'].errors?.['required']">Campo requerido</small>
                <small *ngIf="f['correo'].errors?.['email']">Email inválido</small>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="unidadOrganica" class="form-label">Unidad Orgánica</label>
              <input
                type="text"
                class="form-control"
                id="unidadOrganica"
                formControlName="unidadOrganica"
                readonly
              />
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="estado" class="form-label">Estado</label>
              <select class="form-control" id="estado" formControlName="estado">
                <option value="Activo">Activo</option>
                <option value="Inactivo">Inactivo</option>
                <option value="Suspendido">Suspendido</option>
              </select>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> 
            {{ currentSectorista ? 'Actualizar' : 'Registrar' }}
          </button>
          <button 
            *ngIf="currentSectorista"
            type="button" 
            class="btn btn-secondary" 
            (click)="cancelarEdicion()"
          >
            <i class="bi bi-x-circle"></i> Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Sección Listado de Sectoristas -->
  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0">Listado de Sectoristas</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Nombres</th>
              <th>Apellidos</th>
              <th>Teléfono</th>
              <th>Correo</th>
              <th>Unidad Orgánica</th>
              <th>Estado</th>
              <th>Entidades</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="sectoristas.length === 0">
              <td colspan="8" class="text-center text-muted py-4">
                <i class="bi bi-inbox"></i> No hay sectoristas registrados
              </td>
            </tr>
            <tr *ngFor="let sectorista of sectoristas; let i = index">
              <td>{{ sectorista.nombres }}</td>
              <td>{{ sectorista.apellidos }}</td>
              <td>{{ sectorista.telefono }}</td>
              <td>{{ sectorista.correo }}</td>
              <td>{{ sectorista.unidadOrganica }}</td>
              <td>
                <span 
                  [ngClass]="{
                    'badge bg-success': sectorista.estado === 'Activo',
                    'badge bg-danger': sectorista.estado === 'Inactivo',
                    'badge bg-warning': sectorista.estado === 'Suspendido'
                  }"
                >
                  {{ sectorista.estado }}
                </span>
              </td>
              <td>
                <button 
                  class="btn btn-sm btn-info"
                  (click)="abrirModalEntidades(i)"
                  title="Gestionar entidades"
                >
                  <i class="bi bi-building"></i>
                  {{ sectorista.entidades.length }} entidades
                </button>
              </td>
              <td>
                <button 
                  class="btn btn-sm btn-warning me-2"
                  (click)="editarSectorista(i)"
                  title="Editar"
                >
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button 
                  class="btn btn-sm btn-danger"
                  (click)="eliminarSectorista(i)"
                  title="Eliminar"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Agregar Entidades -->
<div class="modal" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">
          <i class="bi bi-building"></i> Gestionar Entidades - 
          {{ currentSectorista ? currentSectorista.nombres + ' ' + currentSectorista.apellidos : '' }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Entidades Disponibles -->
          <div class="col-md-6">
            <h6 class="mb-3">Entidades Disponibles</h6>
            <div class="list-group">
              <button
                *ngFor="let entidad of getEntidadesDisponiblesParaAgregar()"
                type="button"
                class="list-group-item list-group-item-action"
                (click)="agregarEntidad(entidad)"
              >
                <i class="bi bi-plus-circle text-success me-2"></i>
                {{ entidad.nombre }}
              </button>
              <div *ngIf="getEntidadesDisponiblesParaAgregar().length === 0" class="list-group-item text-muted">
                <i class="bi bi-inbox"></i> Todas las entidades han sido agregadas
              </div>
            </div>
          </div>

          <!-- Entidades Seleccionadas -->
          <div class="col-md-6">
            <h6 class="mb-3">Entidades Seleccionadas</h6>
            <div class="list-group">
              <div *ngIf="entidadesSeleccionadas.length === 0" class="list-group-item text-muted">
                <i class="bi bi-inbox"></i> No hay entidades seleccionadas
              </div>
              <div
                *ngFor="let entidad of entidadesSeleccionadas"
                class="list-group-item d-flex justify-content-between align-items-center"
              >
                <span>{{ entidad.nombre }}</span>
                <button
                  type="button"
                  class="btn btn-sm btn-danger"
                  (click)="eliminarEntidad(entidad.id)"
                >
                  <i class="bi bi-x-circle"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
          <i class="bi bi-x-lg"></i> Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="guardarEntidades()">
          <i class="bi bi-check-lg"></i> Guardar Entidades
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay para el modal -->
<div 
  class="modal-backdrop fade" 
  [class.show]="showModal"
  [style.display]="showModal ? 'block' : 'none'"
></div>
